<!--[if HTML5]><![endif]-->
<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="{{=T.accepted_language or 'en'}}"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="{{=T.accepted_language or 'en'}}"> <!--<![endif]-->
<head>
<title>{{=response.title or request.application}}</title>
  <!--[if !HTML5]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge{{=not request.is_local and ',chrome=1' or ''}}">
  <![endif]-->
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
	   
  <meta charset="utf-8" />

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="{{=request.application}}" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="{{=URL('static','images/favicon.ico')}}" type="image/x-icon">
  <link rel="apple-touch-icon" href="{{=URL('static','images/favicon.png')}}">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="{{=URL('static','js/modernizr.custom.js')}}"></script>

  <!-- include stylesheets -->
  {{  
  response.files.append(URL('static','css/web2py.css'))
  response.files.append(URL('static','css/bootstrap.min.css'))
  response.files.append(URL('static','css/bootstrap-responsive.min.css'))
  response.files.append(URL('static','css/web2py_bootstrap.css'))
  }}

  {{include 'web2py_ajax.html'}}

  {{
  # using sidebars need to know what sidebar you want to use
  left_sidebar_enabled = globals().get('left_sidebar_enabled',False)
  right_sidebar_enabled = globals().get('right_sidebar_enabled',False)
  middle_columns = {0:'span12',1:'span9',2:'span6'}[
    (left_sidebar_enabled and 1 or 0)+(right_sidebar_enabled and 1 or 0)]
  }}

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="{{=URL('static', 'css/web2py_bootstrap_nojs.css')}}" rel="stylesheet" type="text/css" /></noscript>
{{block head}}
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.4.0/ocanvas.min.js"></script>
    <style >    
    .comments_results{
        border: solid 1px;
        border-radius: 7px;
    }
    #comments_list ul, li{
        list-style: none;
        list-style-type: none;
        margin: 0;
        padding: 0; 
    }
    #comments_list ul.noident li.noident {
        list-style-type: none;
        margin: 0;
        padding: 0;
        }
    #comments_list li{
        background:#eee;
        //border: solid 1px;
        border-radius: 7px;
    }
    .modify_comment_li{
        background-color:transparent;
    }

    #tags_list ul, li{
        list-style: none;
        list-style-type: none;
        margin: 0;
        padding: 0; 
    }
    #tags_list ul.noident li.noident {
        list-style-type: none;
        margin: 0;
        padding: 0;
        }
    .tag_options{
        font-size: x-small;
    }
    
    .tag_context_menu{
        display:none;
        position:absolute;
        font-size: x-small;
        border-style:solid;
        border-color:#888;
        border-width:1px;
        border-radius: 7px;
        background:#eee;
        width:80px;  
        min-height:30px;
    }
     .note_context_menu{
        display:none;
        position:absolute;
        font-size: x-small;
        border-style:solid;
        border-color:#888;
        border-width:1px;
        border-radius: 7px;
        background:#eee;
        //width:80px;  
        min-height:30px;
    }   
    .small_font{
        font-size: x-small;
    }
    </style>
        
    {{block viewer_head}}
    {{end}}
{{end}}

</head>



{{block center}}
<div class="videoDiv" id="videoDiv" >
    {{block media_frame}}    
    {{end}}

</div>
<div class="comments_box" id="comments_box" style="{ border:1px solid; border-radius:5px;}" >
    <!--
    <div id="canvas_time_display" > </div>
    <div id="canvas_text_display"> </div>
    -->
    <div class="canvas_div" id="canvas_div" >
        <!--Here canvas will be dynamically added when needed -->
    </div>
    
    <div class="comments_results" style="max-height: 300px; overflow-y: scroll;">
        <ul id="comments_list">
        </ul>
    </div>
</div>

<div class="note_context_menu" id="note_context_menu">
    <span > Time: <span id='canvas_comment_time_display'></span>  </span>
    <a href="javascript:close_note_menu()"> dismiss </a>
    <p id="edit_comment" name="comment" type="text"
            rows="5" cols="35" ></p>
</div>

<div class="tag_context_menu" id="tag_context_menu">
    <span > Time: <span id='canvas_comment_time_display'></span>  </span>
    <span id="tag_name" value="Tag name">  </span> <br/>
    <span><a href="javascript:close_tag_menu()"> dismiss </a></span> 
</div>



<hr/>
<div id="advices">
{{try:}}
    <ul>
    {{for a in advices:}}
        <li>
        By <a href="{{=URL('videos_by', args=a.annotator_id)}}" > {{=a.annotator_id}} </a>
        <p> {{=a.advice_text}}</p>
        </li>
    {{pass}}

    </ul>
{{except:}}
    <!--Problem with displaying advice list-->
{{pass}}
</div>
{{end}}

{{block end_scripts}}

<!-- Load ocanvas -->

<script type="text/javascript">

$(".tag_type_input").css("width","80")

var next_tag_id = -1;
var last_tag_selected = null;
var current_tag_selected = null;
var current_tag_selected_json = null;
var update_comments_time = true;
var current_comment_selected = null;
var current_comment_selected_json = null;
/*
var commentInFocus = false;
$('#comment').focus(function() {
  commentInFocus = true;
  //bind event to post annotation
  //bind start writing to stop note time
});

$('#comment').blur(function() {
  commentInFocus = false;
  //unbind enter to post annotation
  //unbind start writing to stop note time
});
*/

//note modify delete menu
$("#note_context_menu").mouseleave(close_note_menu);

function close_note_menu(){
    $("#note_context_menu").hide();
}

function modif

////////////////////////////////////////////////////////////////////////////////
// TAG edit
////////////////////////////////////////////////////////////////////////////////
//tag modify delete menu
$("#tag_context_menu").mouseleave(close_tag_menu);

function close_tag_menu(){
    $("#tag_context_menu").hide();
}


function show_tag_options(tag_id){
    //will not remove, just hide the tag, for the moment this is easier
    //console.log("show tag options "+tag_id);
    $("#tag_options_"+tag_id).show();
    $('#hide_tag_options_'+tag_id).show();
    $('#show_tag_options_'+tag_id).hide();
}

function hide_tag_options(tag_id){
    //console.log("hide tag options "+tag_id);
    //will not remove, just hide the tag, for the moment this is easier
    $("#tag_options_"+tag_id).hide();
    $('#hide_tag_options_'+tag_id).hide();
    $('#show_tag_options_'+tag_id).show();

}


    var current_time = 0;
    var current_note_time = 0;
    //console.log("setting duration to 0");
    var video_duration = 0;
    var vmplayer = null;

    /*
     * Polling the player for information
     */

    // Update a particular HTML element with a new value
    function updateHTML(elmId, value) {
      document.getElementById(elmId).innerHTML = value;
    }

    function updateValue(elmId, val) {
      document.getElementById(elmId).value = val;
    }

    function updateTime(elmId, val) {
        val = Number(val);
        current_time = val;
        var hh = Math.floor(val/3600);
        var mm = Math.floor(val/60);
        var ss = val%60; 
        tval = hh.toString()+':'+mm.toString()+':'+ss.toString()
        //document.getElementById(elmId).value = tval;//TODO change to jQuery style
        $("#"+elmId).val(tval);
        if(update_comments_time){
            current_note_time = val;
            $("#video_time_comments").val(tval);
        }
    }

    ////////////////////////////////////////////////////////////////////////////////
    //// NEW canvas things -- more interactive
    ////////////////////////////////////////////////////////////////////////////////

    //Vars
    ///////////////////////

    var all_comments = new Array();
    var all_tags = new Array();
    var all_canvas = new Object(); // {};
    var interactive_canvas_div = $('#canvas_div');
    //Functions
    ////////////////////////
    function add_canvas(canvas_name, field_name){
        //find where to put the canvas
        // add the canvas object to DOM
        var canvas_text = '<canvas id="'+canvas_name+'" width="520" height="30"></canvas>';
        //console.log('canvas_text = '+canvas_text);
        
        //WARNING this takes out the text indicating the canvas name
        //interactive_canvas_div.append("<div ><h4>"+field_name+"</h4> </div>");
        
        
        /*del_tag =  "<div id='"+field_name+"_del_tag_option' > </div>"
        tag_options = ""
        //change_tag = "<div id='"+field_name+"_change_tag_option' > "+ tag_options+"  </div>"
        time_display = "<div id='"+field_name+"_time_display' > </div>"
        menu_options = del_tag + change_tag
        canvas_menu = "<div id='canvas_menu_"+field_name+"' > "+ menu_ options +" </div>"
        */
        interactive_canvas_div.append();
        interactive_canvas_div.append(canvas_text);
        //console.log('init oCanvas for this instance');
        // init ocanvas 
        var canvas = oCanvas.create({
	        canvas: "#"+canvas_name,
	        background: "#EEF",
        });
        //console.log('adding to canvas dict');
        all_canvas[canvas_name] = canvas;
        //console.log('DONE');
        // done
    }

    function canvas_draw_tag( tag_json ){
        //console.log("drawing tag");
        //console.log("drawing tag json "+ tag_json);
        //console.log("drawing tag keys"+ Object.getOwnPropertyNames(tag_json));
        //console.log("tag_json.tag_type_name = "+tag_json.tag_type_name);
        tag_json.tag_type_name = tag_json.tag_type_name.replace(" ","_"); // TODO sanitize strings names!!!!
        //console.log("tag_json.evaluation = "+tag_json.evaluation);
        //console.log("tag_json.video_time = "+tag_json.video_time);
        var canvas_name = tag_json.tag_type_name+"_canvas";// document.getElementById("tags_canvas");
        //console.log(" canvas name "+ canvas_name);
        canvas_name = "Comments_canvas"; //WARNING this overrides writing many canvases
        try{
            if(!all_canvas[canvas_name] ){
                //add_canvas(canvas_name, tag_json.tag_type_name);
                add_canvas(canvas_name, "Comments");//WARNING this overrides writing many canvases
            }
        }
        catch(err){
            //console.log(err);
            add_canvas(canvas_name, tag_json.tag_type_name);
        }
        //get canvas
        var canvas = all_canvas[canvas_name];
        //console.log("canvas = "+canvas);
        //console.log("canvas_name = "+canvas_name);
        //get coordinates
        var t=tag_json.video_time.split(":");
        var ntime=Number(t[0])*3600+Number(t[1])*60+Number(t[2]);
        //console.log("tag_json.video_time = "+tag_json.video_time);
        //console.log("video time = "+ntime);
        //console.log("video duration = "+video_duration);
        //var video_duration = 
        var xpos =  (ntime/video_duration ) * 520;
        var ypos = 0;
        //set image source according to result
        var img_src="{{=URL('static','images/QUESTION_icon_20px.png')}}";
        if (tag_json.evaluation=="OK"){
            img_src="{{=URL('static','images/OK_icon_20px.png')}}"
            ypos = 0;
        }else if(tag_json.evaluation=="WARNING"){
            img_src="{{=URL('static','images/WARNING_20px.png')}}"
            ypos = 5;
        }else if(tag_json.evaluation=="BAD"){
            img_src="{{=URL('static','images/BAD_icon_20px.png')}}"    
            ypos = 10;
        }else if(tag_json.evaluation=="QUESTION"){
            img_src="{{=URL('static','images/QUESTION_icon_20px.png')}}"
            ypos = 5;
        }
        //console.log(xpos);
        //console.log(ypos);
        //console.log(img_src);
        //draw tag on canvas
        var tag_obj = canvas.display.image({
	        x: xpos,
	        y: ypos,
	        //origin: { x: "center", y: "center" },
	        image: img_src,
	        height: 20,
	        width: 20,
	        opacity: 0.6,
        });
        canvas.addChild(tag_obj);
        //bind calls 
        tag_obj.bind("click tap", function (e) {
	            $("#tag_context_menu").offset({left:e.pageX - 30,top:e.pageY + 20});
	            //console.log("this = ", this);
	            //console.log("tag_obj = ", tag_obj);
	            on_tag_click(canvas, this, tag_json);
	            
            });
        tag_obj.bind("mouseenter touchenter", function (e) {
	            $("#tag_context_menu").offset({left:e.pageX - 30,top:e.pageY + 20});
	            on_tag_enter(canvas, this, tag_json);

	            
            });
        tag_obj.bind("mouseleave touchleave", function (e) {
	            on_tag_leave(canvas, this, tag_json, ypos);
	            //$("#tag_context_menu").hide();
            });
        return tag_obj;
    }
    //function get_tags(callback){
    function get_tags(){
        //get the tags from dtabase, AJAX call
        //console.log('getting tags by AJAX call');
        //var parsed = null;
        jQuery.ajax({
               type: "POST",
               url: '{{=URL("get_tags")}}',
               data: "video_id={{=video.id}}"
            }).done(function( msg ) {
                //console.log(msg);
                var parsed = jQuery.parseJSON(msg);
                all_tags = parsed;
                for (var i = 0, len = parsed.length; i < len; ++i) {
                    //console.log("JSON object: ");
                    //console.log(parsed[i]);
                    canvas_draw_tag( parsed[i] );
                    add_tag_to_list( parsed[i]);
                    
                }
                //console.log("callback");
                //callback(parsed);
              });
            return false;
        //for every tag, draw it
        //return parsed_tags;
    }


    function on_tag_click(canvas, obj, tag_json){
        //console.log("tag click");
        //console.log("obj = ", obj);
        current_tag_selected = obj;
        //console.log("current_tag_selected = ", current_tag_selected);
        current_tag_selected_json = tag_json;
        //console.log("tag_json = ", tag_json);
        $("#tag_context_menu #tag_name").val(tag_json.tag_type_name).css("width", "90%");
        $("#tag_context_menu").show();
        //on_tag_click_specific(canvas, obj, tag_json);
    }

    function on_comment_click(canvas, obj, comment_json){
        //console.log("comment click");
        current_comment_selected = obj;
        current_comment_selected_json = comment_json;
        $("#edit_comment").text(comment_json.comment);
        on_comment_click_specific(canvas, obj, comment_json);
    }

    function on_tag_enter(canvas, obj, tag_json){
        //console.log("tag enter");
        current_tag_selected = obj;
        current_tag_selected_json = tag_json;
        $("#tag_context_menu #tag_name").val(tag_json.tag_type_name).css("width", "90%");
        $("#tag_context_menu").show();

        //set cursor to arrow
        document.body.style.cursor = 'pointer';
        canvas.removeChild(obj);
        canvas.addChild(obj);
        obj.animate({
		            width: 30,
		            height: 30,
		            y: 0,
		            opacity: 1,
		            }, 350);
        //display time
        //console.log("obj = "+tag_json.video_time);
        //$("#canvas_time_display").text(tag_json.video_time);
    }

    function on_tag_leave(canvas, obj, tag_json, ypos){
        //console.log("tag leave");
        //$("#tag_context_menu").
        //$("#tag_context_menu").hide();
        //set cursor to arrow
        document.body.style.cursor = 'default';
        obj.animate({
		            width: 20,
		            height: 20,
		            y: ypos,
		            opacity: 0.6,
	            }, 350);
    }

    function canvas_draw_comment(comment_json){
     //console.log("drawing comment");
        //console.log("drawing comment json "+ comment_json);
        //console.log("drawing comment keys"+ Object.getOwnPropertyNames(comment_json));
        //console.log("comment_json.video_time = "+comment_json.video_time);
        //select the correct canvas to draw in (name)
        //if canvas does not exist
        //  add_canvas
        //  select canvas
        //draw
        var canvas_name = "Comments_canvas";// document.getElementById("tags_canvas");
        //console.log(" canvas name "+ canvas_name);
        if(!all_canvas[canvas_name] ){
            add_canvas(canvas_name, "Comments");
            //for interactive display
            //interactive_canvas_div.append("<div id='comments_interactive_show'> <span id='canvas_comment_time_display'></span> | <span id='canvas_comment_text_display'></span> </div>");
            //interactive_canvas_div.append("");
        }
        //get canvas
        var canvas = all_canvas[canvas_name];
        //console.log(" canvas  "+ canvas);
        //get coordinates
        var t=comment_json.video_time.split(":");
        var ntime=Number(t[0])*3600+Number(t[1])*60+Number(t[2]);
        var xpos =  (ntime/video_duration ) * 520;
        var ypos = 0;
        //set image source according to result
        var img_src="{{=URL('static','images/comment_icon_20px.png')}}";
        //console.log(xpos);
        //console.log(ypos);
        //console.log(img_src);
        //draw tag on canvas
        var com_obj = canvas.display.image({
	        x: xpos,
	        y: ypos,
	        //origin: { x: "center", y: "center" },
	        image: img_src,
	        height: 20,
	        width: 20,
	        opacity: 0.6,
        });
        canvas.addChild(com_obj);
        //bind calls 
        com_obj.bind("click tap", function (e) {
	            on_comment_click(canvas, this, comment_json);
	            
            });
        com_obj.bind("mouseenter touchenter", function (e) {
	            on_comment_enter(canvas, this, comment_json);
	            $("#note_context_menu").offset({left:e.pageX - 30,top:e.pageY + 20});
            });
        com_obj.bind("mouseleave touchleave", function (e) {
	            on_comment_leave(canvas, this, comment_json);
            });
        
    }
    
    
    //bind comments to enter event
    $('#comment').bind('keypress', function(e) {
        //console.log("comment key pressed = "+e.keyCode);
        //if not whitespace
        if(e.keyCode!=13 && e.keyCode!=32){
            update_comments_time=false;
        }
	    if(e.keyCode==13){
		    update_comments_time=true;
		    annotation_submit();
		    e.preventDefault();
		    $("#comment").val('');
		    return true;
	    }
	    //console.log("update_comments_time = "+update_comments_time);
    });
    //bind comments to enter event
    $('.modify_comment_li').bind('keypress', function(e) {
        console.log("comment key pressed = "+e.keyCode);
        
	    if(e.keyCode==13){
		    modify_comment($("#edit_comment").val());
		    e.preventDefault();
		    return true;
	    }
	    //console.log("update_comments_time = "+update_comments_time);
    });
    
    function sort_comments(){
        
        var list = $('#comments_list');
        var listItems = list.find('li').sort(
                function(a,b){ 
                    //$(a).attr('data-sort')
                    //$(b).attr('data-sort')
                    var t=$(a).attr('data-sort').split(":");
                    var numa=Number(t[0])*3600+Number(t[1])*60+Number(t[2]);
                    t=$(b).attr('data-sort').split(":");
                    var numb=Number(t[0])*3600+Number(t[1])*60+Number(t[2]);
                    return numa-numb; 
                    });
        list.find('li').remove();
        list.append(listItems);
        return true;
    }
    
    
    function setCurrentComment(video_id, video_time, annotator_id, comment){
        var cc = new Object();
        cc.video_id = video_id;
        cc.video_time = video_time;
        cc.annotator_id = annotator_id
        cc.comment = comment;
        current_comment_selected = null;
        current_comment_selected_json = cc;
    }
    var current_comment_id
    var comment_bind_id=0
    function add_comment_to_list( comment_json){
        //TODO comments_list add
        //var ttxt = "<table class='comment_frame' id='"+comment_json.video_time+"'> <tr> <td><span style='cursor:pointer;'>  <a class='li_time' onClick='return setVideoTime(\""+comment_json.video_time+"\");'> "+comment_json.video_time+" </a> </span> </td> <td rowspan='3'> <textarea class='modify_comment_li' type='text' cols='35' max-rows='5' onclick='setCurrentComment("+comment_json.video_id+","+ comment_json.video_time+", "+comment_json.annotator_id+", "+comment_json.comment+"); modify_comment($("#edit_comment").val());' >"+comment_json.comment+"  </textarea></td> </tr> <tr>  </tr>  <tr> <td> <span style='cursor:pointer;'> <a class='small_font' onClick=' return edit_note("+comment_json.video_time+");' > save </a> </span> </td> </tr> </table>";// TODO add edit function to this
        
        var ttxt = "<table class='comment_frame' id='"+comment_json.video_time+"'> <tr> <td><span style='cursor:pointer;'>  <a class='li_time' onClick='return setVideoTime(\""+comment_json.video_time+"\");'> "+comment_json.video_time+" </a> </span> </td> <td rowspan='3'> <span >"+comment_json.comment+"  </span></td> </tr> <tr>  </tr>  <tr> <td> <span style='cursor:pointer;'> <a class='small_font' id='edit_"+comment_bind_id+"' > edit </a> </span> </td> </tr> </table>";// TODO add edit function to this
        
        $("#comments_list").prepend("<li data-sort='"+comment_json.video_time+"'>"+ttxt+"</li>")
        
        console.log("Select "+$("#edit_"+comment_bind_id).text());
        
        $("#edit_"+comment_bind_id).live('click', function(e){
        //console.log("before set ="+current_comment_selected_json.comment);
          setCurrentComment(comment_json.video_id, comment_json.video_time, comment_json.annotator_id, comment_json.comment);
          console.log("setCurrentComment ="+current_comment_selected_json.comment);
          edit_note(e); });
        comment_bind_id = comment_bind_id+1;//increment, so ids are never repeated
        //
        sort_comments();
        //TODO focus on this last inserted comment
        /*var ttag = "#"+comment_json.video_time;
        //console.log(ttag);
        //console.log($(ttag));
        //console.log($(ttag).position());
        var container = $("#comments_list"), scrollTo = $("#"+comment_json.video_time);
        container.animate({
            scrollTop: scrollTo.position().top - container.offset().top + container.scrollTop()
        }); //position and offset are giving  "undefined" and I don't know why
        */
    }

    function setCurrentTag(video_id, video_time, annotator_id, tag_type_name, evaluation){
        var cc = new Object();
        cc.video_id = video_id;
        cc.video_time = video_time;
        cc.annotator_id = annotator_id;
        cc.tag_type_name = tag_type_name;
        cc.evaluation = evaluation;
        current_tag_selected = null;
        current_tag_selected_json = cc;
    }
    var current_comment_id
    function add_tag_to_list( tag_json){
        //TODO comments_list add
        //var ttxt = "<table class='comment_frame' id='"+comment_json.video_time+"'> <tr> <td><span style='cursor:pointer;'>  <a class='li_time' onClick='return setVideoTime(\""+comment_json.video_time+"\");'> "+comment_json.video_time+" </a> </span> </td> <td rowspan='3'> <textarea class='modify_comment_li' type='text' cols='35' max-rows='5' onclick='setCurrentComment("+comment_json.video_id+","+ comment_json.video_time+", "+comment_json.annotator_id+", "+comment_json.comment+"); modify_comment($("#edit_comment").val());' >"+comment_json.comment+"  </textarea></td> </tr> <tr>  </tr>  <tr> <td> <span style='cursor:pointer;'> <a class='small_font' onClick=' return edit_note("+comment_json.video_time+");' > save </a> </span> </td> </tr> </table>";// TODO add edit function to this
        
        var ttxt = "<table class='comment_frame' id='"+tag_json.video_time+"'> <tr> <td><span style='cursor:pointer;'>  <a class='li_time' onClick='return setVideoTime(\""+tag_json.video_time+"\");'> "+tag_json.video_time+" </a> </span> </td> <td rowspan='3'> <span >"+tag_json.tag_type_name+"  </span></td> <td rowspan='3'> <span ><img id='"+tag_json.evaluation+"' src='{{=URL('static','images')}}/"+tag_json.evaluation+"_icon.png' width='15'/ >  </span></td> </tr> <tr>  </tr>  <tr> <td> <span style='cursor:pointer;'> <a class='small_font' id='edit_"+comment_bind_id+"' > edit </a> </span> </td> </tr> </table>";// TODO add edit function to this
        
        $("#comments_list").prepend("<li data-sort='"+tag_json.video_time+"'>"+ttxt+"</li>")
        
        console.log("Select "+$("#edit_"+comment_bind_id).text());
        
        $("#edit_"+comment_bind_id).live('click', function(e){
        //console.log("before set ="+current_comment_selected_json.comment);
          setCurrentTag(tag_json.video_id, tag_json.video_time, tag_json.annotator_id, tag_json.tag_type_name, tag_json.evaluation);
        $("#tag_context_menu").offset({left:e.pageX - 30,top:e.pageY + 20});
          //console.log("setCurrentComment ="+current_comment_selected_json.comment);
        $("#tag_context_menu #tag_name").val(tag_json.tag_type_name).css("width", "90%");
        $("#tag_context_menu").show();
          });
        comment_bind_id = comment_bind_id+1;//increment, so ids are never repeated
        //
        sort_comments();
        //TODO focus on this last inserted comment
        /*var ttag = "#"+comment_json.video_time;
        //console.log(ttag);
        //console.log($(ttag));
        //console.log($(ttag).position());
        var container = $("#comments_list"), scrollTo = $("#"+comment_json.video_time);
        container.animate({
            scrollTop: scrollTo.position().top - container.offset().top + container.scrollTop()
        }); //position and offset are giving  "undefined" and I don't know why
        */
    }

    
    function get_comments(){
        //get the tags from dtabase, AJAX call
        //console.log('getting comments by AJAX call');
        //var parsed = null;
        $.ajax({
               type: "POST",
               url: '{{=URL("get_comments")}}',
               data: "video_id={{=video.id}}"
            }).done(function( msg ) {
                //console.log(msg);
                var parsed = $.parseJSON(msg);
                all_comments = parsed;
                for (var i = 0, len = parsed.length; i < len; ++i) {
                    //console.log("JSON object: ");
                    //console.log(parsed[i]);
                    canvas_draw_comment( parsed[i] ); //draws the comment in the results canvas
                    add_comment_to_list( parsed[i] ); //writes the comment in the 
                    
                }
                //console.log("callback");
                //callback(parsed);
              });
            return false;
    }

    function on_comment_enter(canvas, obj, comment_json){
        //console.log("comment enter");
        //set cursor to arrow
        $("#note_context_menu").show();
        current_comment_selected = obj;
        current_comment_selected_json = comment_json;
        $("#edit_comment").text(comment_json.comment);
        document.body.style.cursor = 'pointer';
        canvas.removeChild(obj);
        canvas.addChild(obj);
        obj.animate({
		            width: 30,
		            height: 30,
		            y: 0,
		            opacity: 1,
		            }, 350);
        //$("#canvas_time_display").text(comment_json.video_time);
        $("#canvas_comment_time_display").text(comment_json.video_time);
        //$("#canvas_comment_text_display").text(comment_json.comment);
    }

    function on_comment_leave(canvas, obj, comment_json, ypos){
        //console.log("comment leave");
        $("#tag_context_menu").hide();
        //set cursor to arrow
        document.body.style.cursor = 'default';
        obj.animate({
		            width: 20,
		            height: 20,
		            y: ypos,
		            opacity: 0.6,
	            }, 350);
    }

    ////////////////////////////////////////////////////////////////////////////////
    ////INIT
    ////////////////////////////////////////////////////////////////////////////////

    //init functions for interactive canvas 

    function init_interactive_canvas() {
        //console.log('INIT interactive canvas');
        //get tagging options TODO
        //draw interactive tagging canvas TODO
        //console.log('getting comments');
        var comments = get_comments();
        //console.log(comments);
        //console.log('getting tags');
        var tags = get_tags();
        //console.log(tags);
        //console.log('DONE init interactive canvas');
    }
    </script>
    {{block video_init_scripts}}
    {{end}}
{{end}}

